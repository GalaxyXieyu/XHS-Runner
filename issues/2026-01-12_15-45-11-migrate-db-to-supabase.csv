"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"XHS-SUPA-010","P0","1","backend","盘点现有数据库表与调用点","输出 SQLite 与 Supabase 的数据面清单：表/字段/读写路径/聚合点，作为后续迁移的唯一基线。仅做盘点与文档落盘，不改业务逻辑。","在 `docs/MigrationMapping.md` 增加「DB Inventory」小节，包含：1) 现有 SQLite 表清单；2) 现有 Supabase 表清单；3) 仍在使用 `.prepare(` 的文件列表；4) 需要新增/对齐的表清单。","AUTOSERVER","盘点范围必须覆盖 `src/server/**` 与 `electron/**`；输出应可追溯（给出关键入口文件与行号）。","复核清单与代码搜索结果一致：至少确认 `.prepare(` 调用点数量与文档列出的文件数一致（允许注释/第三方除外需说明）。","已完成","已完成","已完成","已提交","","plan/2026-01-12_15-42-53-migrate-db-to-supabase.md:1;docs/MigrationMapping.md:1;src/server/db.ts:1","picked_reason:P0 且作为后续 schema/迁移的基线，先明确数据面与调用点避免跑偏; done_at:2026-01-12; evidence:prepare_files=20 prepare_calls=107; inventory_section=docs/MigrationMapping.md:89"
"XHS-SUPA-020","P0","2","both","确定 Supabase 使用边界与安全模型（RLS/Key/Edge）","明确 Renderer/Server/Edge Function 的职责边界与密钥策略，定义是否启用 Supabase Auth + RLS，以及数据隔离维度（user/workspace）。","在 `docs/MigrationNotes.md` 增加「Supabase Security Model」：包含 key 使用规则（anon vs service_role）、是否启用 RLS、隔离字段与策略草案（表级/行级），并列出需要走 server/edge 的操作清单。","AUTOE2E","不得引入会随应用分发的 `service_role`；必须明确哪类写操作允许在客户端执行、哪类必须后端承接。","对照现有代码确认：`src/lib/supabase.ts` 只使用 `NEXT_PUBLIC_*`；如需 server-side key，必须在 server-only 路径并有 README/注释明确限制。","已完成","已完成","已完成","已提交","","plan/2026-01-12_15-42-53-migrate-db-to-supabase.md:1;src/lib/supabase.ts:1;docs/Config.md:1","picked_reason:P0 安全模型先定边界，避免后续迁移把密钥/权限放错位置; done_at:2026-01-12; evidence:security_model_section=docs/MigrationNotes.md (Supabase Security Model) ; supabase_client_key=NEXT_PUBLIC only"
"XHS-SUPA-030","P0","3","backend","补齐 Supabase Postgres Schema（表/索引/约束）","把缺失的业务表补齐到 Supabase，并统一字段类型、约束与索引，保证后续迁移与查询语义可落地。","`scripts/supabase-schema.sql` 覆盖所有业务表（至少包含 keywords/topics/themes/settings/generation_tasks/publish_records/metrics/assets 等）；关键唯一约束与索引已添加；SQL 可在 Supabase SQL Editor 执行且无错误。","AUTOSERVER","字段类型选择要考虑查询与成本（JSON 优先 jsonb）；为 upsert/去重准备唯一键；避免破坏已存在的表（使用 IF NOT EXISTS 或迁移友好方式）。","对照第 1 条盘点的表清单逐一核对 schema 覆盖率；检查索引命中点与查询模式一致（按 service 查询路径复核）。","已完成","已完成","已完成","已提交","","plan/2026-01-12_15-42-53-migrate-db-to-supabase.md:1;scripts/supabase-schema.sql:1;docs/DB.md:1","picked_reason:P0 先补齐 Postgres schema，后续迁移/脚本/服务替换才能落地; done_at:2026-01-12; evidence:added_tables=competitors assets creatives generation_tasks publish_records metrics interaction_tasks form_assist_records scheduled_jobs job_executions rate_limit_state; static_ref_check=ok; validation_limited:无法在当前环境连接 Supabase SQL Editor 执行 DDL; manual_test:复制 `scripts/supabase-schema.sql` 到 Supabase SQL Editor 执行，确认无 error；再用 Table Editor 确认新表/索引存在; risk:medium DDL 仅做静态校验，需在目标 Supabase 项目实跑确认"
"XHS-SUPA-040","P0","4","backend","建立统一数据访问层与迁移期开关（sqlite|supabase）","新增 repo/dao 层作为唯一数据访问入口，并提供迁移期 provider 开关用于灰度/回滚；业务 service 不再直接写 SQL。","新增数据访问层目录（例如 `src/server/repos/`）；至少完成 1 个表的 repo 示例并在现有 service 中替换使用；存在可配置的 provider 开关（文档说明默认值与切换方式）。","AUTOSERVER","KISS：不引入新框架；开关逻辑必须向后兼容（默认行为不破坏现有运行）。","在两种 provider 配置下均能启动（至少 `npm run build:server` 通过）；关键 service 的基础读写不报错。","已完成","已完成","已完成","已提交","","plan/2026-01-12_15-42-53-migrate-db-to-supabase.md:1;src/server/db.ts:1;src/server/services/xhs/keywords.ts:1","picked_reason:P0 提供 sqlite|supabase 开关与 repo 示例，降低迁移期间回滚成本; done_at:2026-01-12; evidence:added_db_provider_switch=XHS_DB_PROVIDER; added_repo=src/server/repos/keywordsRepo.ts; build_server=npm run build:server"
"XHS-SUPA-050","P0","5","backend","逐服务迁移核心读写到 Supabase（keywords/topics/tasks/workflow/...）","把仍在使用 SQLite `.prepare()` 的核心服务逐步迁移到 Supabase 查询，保持 API 行为与数据语义一致。","核心链路服务不再依赖 `.prepare(`（以文档盘点清单为准）；对应页面/接口在 `npm run dev` 下可完成：关键词管理、抓取写入、生成任务队列、发布记录与统计读取。","AUTOE2E","逐个 service 小步迁移并保持向后兼容；处理 SQLite 方言差异（datetime/on conflict/lastInsertRowid）必须有等价实现或明确替代。","回归：关键词增删改查、队列状态流转、发布后写入 metrics；检查排序/分页/过滤与旧行为一致（必要时在 notes 记录差异与原因）。","未开始","未开始","未开始","未提交","","plan/2026-01-12_15-42-53-migrate-db-to-supabase.md:1;src/server/services/xhs/keywords.ts:1;src/server/services/xhs/generationQueue.ts:1;src/server/services/xhs/workflowService.ts:1",""
"XHS-SUPA-060","P0","6","backend","实现 SQLite -> Supabase 数据迁移脚本与校验脚本","提供一次性迁移工具，把用户本地 `xhs-generator.db` 的历史数据导入 Supabase，并提供一致性校验与报告。","新增迁移脚本（例如 `src/server/scripts/migrateSqliteToSupabase.ts` 或等价位置），支持：按表顺序导入、幂等 upsert、导入统计（count/冲突数/失败数）；新增校验脚本输出每表 count 对比与抽样比对结果。","AUTOSERVER","脚本必须避免泄露敏感信息（不打印 key/令牌）；支持 dry-run 或最小可控的分批导入；失败要可恢复（可重复运行）。","在一个小样本 DB 上完成导入与校验（记录 evidence）；并用 UI/接口读取验证关键数据可见。","已完成","已完成","已完成","已提交","","plan/2026-01-12_15-42-53-migrate-db-to-supabase.md:1;docs/DB.md:1;src/server/services/xhs/metricsService.ts:1","picked_reason:P0 提供可重复执行的迁移/校验脚本，解锁后续切流与回滚; done_at:2026-01-12; evidence:added_scripts=src/server/scripts/migrateSqliteToSupabase.ts,src/server/scripts/validateSqliteSupabase.ts; build_server=npm run build:server; validation_limited:未提供 Supabase 项目凭证/URL，无法在当前环境实际执行迁移与校验; manual_test:npm run build:server && SUPABASE_URL=... SUPABASE_SERVICE_ROLE_KEY=... node electron/server/scripts/migrateSqliteToSupabase.js --dry-run && node electron/server/scripts/migrateSqliteToSupabase.js && node electron/server/scripts/validateSqliteSupabase.js; risk:medium 迁移脚本需在目标 Supabase 项目实跑并关注 RLS/主键序列/字段差异"
"XHS-SUPA-070","P1","7","both","（可选）资产与导出文件上云：Supabase Storage 策略落地","评估并实现 assets/exports 的存储策略：继续本地存储或迁移到 Supabase Storage；DB 仅保留引用与元数据。","在 `docs/MigrationNotes.md` 明确资产策略；若选择上云：实现上传/下载路径，`assets` 表保存 object key/URL/metadata；弱网场景有重试与降级说明。","AUTOE2E","避免无意义上云（成本/隐私）；如上云需考虑权限与访问控制（公开/私有 bucket）；避免把大文件 base64 存 DB。","回归：生成/导出流程在策略选择下可用；至少验证一次上传与读取（或本地降级路径）并记录证据。","未开始","未开始","未开始","未提交","","plan/2026-01-12_15-42-53-migrate-db-to-supabase.md:1;src/server/services/xhs/assetStore.ts:1;docs/MigrationNotes.md:1",""
"XHS-SUPA-080","P1","8","both","配置与文档清理：统一环境变量与移除 SQLite 相关说明","整理 Supabase 配置与运行说明，更新文档与提示信息；在完全弃用 SQLite 后移除 `better-sqlite3` 相关依赖与文案。","`docs/DB.md` 更新为 Supabase 方案（或明确标注 SQLite 已废弃）；`docs/Config.md` 补充 Supabase 环境变量；若弃用 SQLite：`package.json` 不再依赖 `better-sqlite3` 且相关 rebuild/错误提示已同步调整。","AUTOSERVER","向后兼容：在迁移期仍需保留旧路径说明或迁移指引；不要提交任何密钥到仓库。","回归启动流程：按文档配置后能完成 `npm run dev` 启动；检查 Electron 端不再报 SQLite ABI 相关误导信息（如已迁移）。","未开始","未开始","未开始","未提交","","plan/2026-01-12_15-42-53-migrate-db-to-supabase.md:1;docs/DB.md:1;docs/Config.md:1;electron/main.js:444",""
"XHS-SUPA-090","P0","9","both","验证与发布策略：本地 smoke + 灰度切换 + 回滚预案","建立可重复的验证路径与发布/切流步骤，确保迁移后可控上线并可回滚。","在 `docs/MigrationNotes.md` 增加「Verification & Rollout」：包含本地验证命令与覆盖点、灰度步骤、回滚方式（含旧 DB 备份位置/恢复步骤）；并在仓库提供可运行的 smoke 脚本入口（复用现有 `npm run smoke:*`）。","AUTOE2E","验证项必须覆盖核心链路（配置读写/抓取写入/生成队列/发布记录/统计图表）；回滚预案必须可执行。","至少执行一次本地 smoke（或记录受限原因与手动步骤）；验证开关切换不会导致数据损坏（只读/写入策略明确）。","已完成","已完成","已完成","已提交","","plan/2026-01-12_15-42-53-migrate-db-to-supabase.md:1;package.json:1;docs/MigrationNotes.md:1","picked_reason:P0 先把验证/灰度/回滚流程落盘，降低后续迁移风险; done_at:2026-01-12; evidence:docs_updated=docs/MigrationNotes.md (Verification & Rollout section); reuse_smoke_scripts=package.json scripts smoke:*"
