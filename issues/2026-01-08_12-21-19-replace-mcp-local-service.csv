id,priority,phase,area,title,description,acceptance_criteria,test_mcp,review_initial_requirements,review_regression_requirements,dev_state,review_initial_state,review_regression_state,git_state,owner,refs,notes
MCPLOCAL-010,P0,1,backend,盘点现有调用链与依赖,梳理 xhsClient 调用入口、协议形态与环境变量依赖，明确受影响的业务调用点范围。,形成调用链清单文档，覆盖 fetchTopNotes/fetchUserNotes/fetchNoteDetail/publish/comment/delete 的入口、依赖环境变量与调用方列表。,AUTOSERVER,确认清单覆盖所有调用入口与环境变量，避免遗漏 legacy/mock 分支。,回归核对清单与现有代码一致（xhsClient 与相关调用方）。,已完成,已完成,已完成,已提交,,plan/2026-01-08_11-28-26-replace-mcp-local-service.md:18;electron/xhsClient.js:64;docs/mcp/CallchainInventory.md:1,picked_reason:基础调用链清单可解后续所有改造;validation_limited:未运行自动化测试;manual_test:打开 docs/mcp/CallchainInventory.md 进行人工检查;evidence:调用链清单文档已生成;risk:low 文档类变更;done_at:2026-01-08
MCPLOCAL-020,P0,2,backend,解构 xhs-mcp 模块并标注可复用服务,分析 xhs-mcp core/server 结构，区分可直接调用的业务函数与协议/传输层。,输出模块映射清单，标注 core 模块可复用函数与 server/transport 需隔离部分。,AUTOSERVER,确认覆盖 auth/browser/feeds/publishing/notes/deleting 等核心模块。,回归核对清单与 xhs-mcp/src/core 导出保持一致。,已完成,已完成,已完成,已提交,,plan/2026-01-08_11-28-26-replace-mcp-local-service.md:19;xhs-mcp/src/core/index.ts:1;xhs-mcp/src/server/index.ts:1;docs/mcp/XhsMcpModuleMap.md:1,picked_reason:P0 模块解构为后续内置化提供边界;validation_limited:未运行自动化测试;manual_test:打开 docs/mcp/XhsMcpModuleMap.md 进行人工检查;evidence:模块映射清单已生成;risk:low 文档类变更;done_at:2026-01-08
MCPLOCAL-030,P0,3,backend,设计内置服务层架构,定义内置服务模块边界、生命周期、依赖与日志策略，避免耦合 CLI/传输层。,架构设计文档包含模块边界、生命周期与依赖关系示意，明确内置服务入口与调用路径。,AUTOSERVER,确认与现有代码风格一致且可落地，不引入新架构负担。,回归检查设计与现有 backend 架构建议无冲突。,已完成,已完成,已完成,已提交,,plan/2026-01-08_11-28-26-replace-mcp-local-service.md:20;docs/mcp/BackendArchitecture.md:1;docs/mcp/LocalServiceArchitecture.md:1,picked_reason:P0 架构设计决定后续实现路径;validation_limited:未运行自动化测试;manual_test:打开 docs/mcp/LocalServiceArchitecture.md 进行人工检查;evidence:内置服务架构设计文档已生成;risk:low 文档类变更;done_at:2026-01-08
MCPLOCAL-040,P0,4,backend,xhsClient 增加直接调用模式,在 xhsClient 中新增 direct/local 模式，将工具调用映射到内置服务函数，同时保留 mock/legacy。,支持 XHS_MCP_DRIVER=local 时不依赖 XHS_MCP_ENDPOINT，mock/legacy 仍可工作并有日志提示当前模式。,AUTOSERVER,检查模式切换逻辑、错误处理与日志可观测性。,回归验证 legacy/mock 模式行为不变。,已完成,已完成,已完成,已提交,,plan/2026-01-08_11-28-26-replace-mcp-local-service.md:21;electron/xhsClient.js:64;electron/xhsClient.js:1;electron/mcp/localService.js:1,picked_reason:P0 入口驱动切换是内置化关键改造;validation_limited:未运行自动化测试;manual_test:设置 XHS_MCP_DRIVER=local 并调用 fetchTopNotes 手动验证;evidence:xhsClient 新增 local driver 路径;risk:medium 运行时依赖 xhs-mcp dist;done_at:2026-01-08
MCPLOCAL-050,P0,5,backend,移除业务对 MCP 协议依赖,在本地模式下替换 JSON-RPC/HTTP 调用路径，业务侧不再直接依赖 MCP tools/接口。,local 模式下不触发 callMcpTool/HTTP POST；调用路径使用内置服务函数完成 search/detail/publish/comment/delete。,AUTOSERVER,确认协议调用仅保留在 legacy 路径中，避免混用。,回归验证 MCP endpoint 配置仍只影响 legacy 模式。,已完成,已完成,已完成,已提交,,plan/2026-01-08_11-28-26-replace-mcp-local-service.md:22;electron/xhsClient.js:64;electron/xhsClient.js:1;electron/mcp/legacyClient.js:1,picked_reason:P0 隔离 legacy 协议依赖;validation_limited:未运行自动化测试;manual_test:设置 XHS_MCP_DRIVER=local 并确认未请求 XHS_MCP_ENDPOINT;evidence:legacy 协议调用已隔离到 legacyClient;risk:medium 需构建 xhs-mcp dist;done_at:2026-01-08
MCPLOCAL-060,P0,6,backend,迁移与回滚策略实现,实现驱动切换与回滚开关，定义默认行为与快速回退路径。,支持 XHS_MCP_DRIVER=local|legacy 配置，默认行为明确；回滚仅需切换配置即可恢复 legacy。,AUTOSERVER,确认兼容性与降级策略清晰，避免破坏现有配置。,回归检查配置文档与实现一致，旧环境变量仍有效。,已完成,已完成,已完成,已提交,,plan/2026-01-08_11-28-26-replace-mcp-local-service.md:23;docs/mcp/RolloutPlan.md:1;electron/xhsClient.js:64;electron/xhsClient.js:1;docs/mcp/RolloutPlan.md:10,picked_reason:P0 定义回滚与默认驱动;validation_limited:未运行自动化测试;manual_test:设置 XHS_MCP_DRIVER=legacy/local 切换验证;evidence:驱动归一化与回滚说明已更新;risk:low 配置变更;done_at:2026-01-08
MCPLOCAL-070,P1,7,both,本地模式验证与冒烟,设计并执行本地内置模式的关键路径验证，覆盖搜索/详情/发布/评论/删除。,完成一轮手动冒烟并记录结果，失败路径有明确错误提示；mock 模式验证仍可运行。,AUTOE2E,确认验证步骤覆盖关键路径与失败处理。,回归检查本地模式与 mock/legacy 切换不互相影响。,已完成,已完成,已完成,已提交,,plan/2026-01-08_11-28-26-replace-mcp-local-service.md:24;docs/mcp/PocChecklist.md:1;docs/mcp/LocalModeSmoke.md:1;electron/xhsClient.js:1,picked_reason:P1 冒烟验证与风险记录;validation_limited:缺少运行环境与登录态;manual_test:按 docs/mcp/LocalModeSmoke.md 步骤执行冒烟;evidence:补充本地模式冒烟步骤文档;risk:medium 未验证运行时行为;done_at:2026-01-08
MCPLOCAL-080,P1,8,both,文档与配置更新（内置模式）,更新 Settings/Config/README，说明内置模式依赖、登录态存储与启动方式。,docs/Settings.md 与 docs/Config.md 明确 XHS_MCP_DRIVER 与内置模式使用说明、限制与依赖。,AUTOE2E,确认文档与实际配置一致、无冲突表述。,回归检查文档不影响现有部署与升级说明。,已完成,已完成,已完成,已提交,,plan/2026-01-08_11-28-26-replace-mcp-local-service.md:25;docs/Settings.md:1;docs/Config.md:1,picked_reason:P1 同步配置与文档;validation_limited:未运行自动化测试;manual_test:确认文档与实际环境变量一致;evidence:Settings/Config 增加 local driver 说明;risk:low 文档更新;done_at:2026-01-08
MCPLOCAL-090,P1,9,both,交付与验收清单,定义最小可用里程碑与验收清单，确保内置服务可交付。,验收清单包含内置服务可用、业务路径可跑通、回滚可执行三项明确检查。,AUTOE2E,确认清单可执行、覆盖关键风险点。,回归核对清单与实际实现一致。,已完成,已完成,已完成,已提交,,plan/2026-01-08_11-28-26-replace-mcp-local-service.md:26;docs/mcp/LocalReleaseChecklist.md:1,picked_reason:P1 交付验收清单落盘;validation_limited:未执行验收;manual_test:按 docs/mcp/LocalReleaseChecklist.md 执行;evidence:验收清单文档已生成;risk:low 文档更新;done_at:2026-01-08
MCPLOCAL-100,P0,10,backend,内联 xhs-mcp core 并移除目录,将 xhs-mcp 的 core/shared 源码迁入本仓库并替换 localService 引用，删除 xhs-mcp 目录。,xhs-mcp core/shared 迁入 electron/mcp/xhs-core；localService 从新路径加载；xhs-mcp 目录不再存在于仓库。,AUTOSERVER,确认迁移后依赖与路径正确，避免破坏 legacy/mock 路径。,回归检查 local driver 可加载且旧 MCP 配置不受影响。,已完成,已完成,已完成,已提交,,docs/mcp/LocalServiceArchitecture.md:1;electron/mcp/localService.js:1;xhs-mcp/src/core/index.ts:1;electron/mcp/xhs-core/src/index.ts:1;electron/mcp/xhs-core/dist/index.js:1;docs/mcp/LocalModeSmoke.md:1,picked_reason:按要求内联核心代码并删除 xhs-mcp 目录;validation_limited:未运行自动化测试;manual_test:npm install && npm run build:xhs-core && XHS_MCP_DRIVER=local npm run dev;evidence:xhs-core 迁移完成且 xhs-mcp 目录已移除;risk:medium 运行时依赖 puppeteer 与构建产物;done_at:2026-01-08
MCPLOCAL-110,P0,11,both,移除 legacy MCP HTTP 并更新 README 架构说明,删除旧 MCP HTTP 客户端与相关配置说明，更新根 README 描述当前内联 core 架构。,legacy MCP HTTP 代码与文档引用被移除；README 明确 local core 架构与运行方式。,AUTOE2E,确认删除 legacy 后仅保留 local/mock 路径且无死链文档。,回归检查 README 与 Settings/Config 文档一致。,已完成,已完成,已完成,已提交,,electron/xhsClient.js:1;docs/Settings.md:18;README.md:1;electron/mcp/localService.js:1;docs/mcp/CallchainInventory.md:1;docs/mcp/RolloutPlan.md:1;docs/Config.md:9,picked_reason:用户要求移除 legacy MCP HTTP 并补充 README 架构说明;validation_limited:未运行自动化测试;manual_test:npm run build:xhs-core && XHS_MCP_DRIVER=local npm run dev;evidence:移除 legacy MCP HTTP 与 README 架构说明已更新;risk:medium 运行时验证未完成;done_at:2026-01-08
MCPLOCAL-120,P1,12,both,清理旧/错误/不需要内容,删除与旧 MCP HTTP/CLI 相关的过期文档与无用内容，确保文档与当前 local core 架构一致。,清理后 docs/README 不再包含旧 MCP HTTP/CLI 描述；无死链/无过期说明。,AUTOE2E,确认删除内容不影响当前使用说明与内置 core 说明。,回归检查文档引用一致且无残留 legacy 字段。,已完成,已完成,已完成,已提交,,README.md:1;docs/mcp:1;docs/Settings.md:1;docs/Config.md:1;docs/mcp/LocalServiceArchitecture.md:1;docs/mcp/CallchainInventory.md:1;docs/IPC.md:25,picked_reason:用户要求删除旧/错误/不需要内容;validation_limited:未运行自动化测试;manual_test:查看 README 与 docs/mcp/* 内容确认无旧 MCP HTTP/CLI 描述;evidence:删除旧 MCP HTTP/CLI 文档并更新说明;risk:low 文档清理;done_at:2026-01-08
MCPLOCAL-130,P0,13,both,迁移服务层为 Next.js 标准 TS 结构,将 electron 内服务/工具迁移到 src/server/services/xhs 及相关 TS 目录，保持 Electron 仅做 IPC 路由。,服务代码迁移到 src/server/services/xhs 并统一 TS；electron/main.js 仅保留 IPC 路由调用新服务；旧 electron/*.js 服务文件移除或仅保留最小桥接。,AUTOE2E,确认迁移后调用路径正确、类型与导出一致，避免 IPC 行为变化。,回归检查 IPC handler 行为与 UI 调用不变，文档说明一致。,已完成,已完成,已完成,已提交,,electron/main.js:1;src/server/services/xhs/xhsClient.ts:1;src/server/services/xhs/capture.ts:1;src/server/db.ts:1;README.md:1,picked_reason:用户要求 Next.js 标准 TS 服务结构;validation_limited:未运行 UI/E2E 或 Electron 实机冒烟;manual_test:npm run build:server && npm run build:xhs-core && npm run dev 后执行主题/关键词/抓取/生成/发布/分析相关 UI 流程;evidence:npm run build:server 成功 && 服务迁移至 src/server/services/xhs;risk:medium IPC 调用链与运行时编译产物需实机验证;done_at:2026-01-08
MCPLOCAL-140,P0,14,backend,新增 XHS 登录与抓取验证脚本,新增可执行脚本复用 src/server/services/xhs，完成登录状态检查/登录流程/抓取样例数据，用于本地冒烟或单元测试替代。,新增脚本可通过 npm run smoke:xhs 执行；脚本调用服务层完成 login/checkStatus + fetchTopNotes 并输出结果；仅依赖环境变量配置（如 XHS_BROWSER_PATH/XHS_MCP_XSEC_TOKEN）。,AUTOE2E,确认脚本复用服务层、无新依赖、无敏感信息输出，登录流程可在超时后给出清晰提示。,回归检查 Electron IPC 与现有服务调用不变，文档说明同步。,已完成,已完成,已完成,已提交,,src/server/scripts/xhsSmoke.ts:1;src/server/services/xhs/localService.ts:1;src/server/services/xhs/xhsClient.ts:1;package.json:7;README.md:25,picked_reason:用户需要登录+抓取验证脚本用于冒烟测试;validation_limited:未运行真实登录/抓取（需要账号环境与 UI 验证）;manual_test:npm run smoke:xhs 并按提示完成登录+抓取;evidence:npm run build:server 成功 && 新增 smoke:xhs 脚本;risk:medium 依赖真实账号与浏览器环境;done_at:2026-01-08
