"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"XHSIMG-010","P0","1","backend","梳理参考项目 Gemini/即梦调用契约","仅阅读 /Volumes/DATABASE/code/business/ai-images-generated 的“调用实现代码”，输出 Gemini/即梦的 URL/鉴权/请求体/响应体/错误码与重试策略对照表，作为本项目修正依据。","在本仓库落盘一份契约对照材料（可追加到 plan 或新增 docs 文件），至少包含：Gemini 与 即梦各自的 endpoint、auth 方式、请求 body schema、成功响应 schema、失败响应/错误码与重试/限流策略；并标注对应源码位置（path:line），且不包含任何真实密钥。","AUTOSERVER","禁止复制/提交任何 .env 或真实 key；对照表必须包含来源路径与关键文件定位；仅做“契约描述”，不提前做实现改动。","测试范围：契约对照材料的完整性与可跳转 refs；测试边界：不得包含 sk- 前缀等敏感信息、不得出现未加密 key；测试方法：本地 rg 扫描敏感串（如 sk-、api_key）并人工抽查 refs 跳转可定位到具体实现。","已完成","已完成","已完成","已提交","","plan/2026-01-14_13-43-32-gemini-jimeng-remote-only.md:16;docs/ContentGenerationDesign.md:190;docs/ImageProviderReferenceContract.md:1","picked_reason:作为所有实现的契约来源/解阻塞优先; picked_at:2026-01-14 13:56:34 | done_at:2026-01-14 13:59:18 | evidence:added docs/ImageProviderReferenceContract.md + secret scan(rg sk-)"
"XHSIMG-020","P0","2","both","定义远程-only 边界并移除 Nanobanana Mock","明确“图片生成仅远程模式”的系统边界：移除 NANOBANANA_MODE/mock 与设置页 nanobananaMode；并评估/澄清 XHS_MCP_DRIVER=mock 是否仅用于 XHS 驱动（不影响图片生成）。","代码与 UI 中不再存在可选的 nanobananaMode=mock（包括下拉选项与默认值）；后端不再生成 placeholder PNG；文档中对“图片生成”不再描述 mock 模式；若保留 XHS_MCP_DRIVER=mock，其含义在 docs 中明确为“XHS driver 降级”，不与图片生成混用。","AUTOSERVER,AUTOFRONTEND","删除 mock 需同步处理：默认值、文档提示、错误信息；避免破坏 XHS driver 的 local/mock 驱动语义；涉及环境变量/设置项变更需提供兼容迁移路径。","测试范围：设置读写、图片生成链路（不产生 placeholder）、相关文档说明；测试边界：未配置 baseUrl/key 时应明确报错而不是生成假图；测试方法：先用后端脚本触发一次生成并观察失败/成功信息，再打开设置页确认无 Mock 选项且保存后立即生效。","已完成","已完成","已完成","已提交","","plan/2026-01-14_13-43-32-gemini-jimeng-remote-only.md:17;src/server/services/xhs/integration/nanobananaClient.ts:7;src/components/settings/ApiConfigTab.tsx:355;src/server/settings.ts:40;docs/Generation.md:15;docs/ContentGenerationDesign.md:178","picked_reason:先移除图片生成 mock 以锁定远程链路; picked_at:2026-01-14 14:01:22 | done_at:2026-01-14 14:06:35 | validation_limited:未执行 Electron/Next UI 手动回归与真实远程调用 | manual_test:1) npm run dev 2) 进入设置页->Nanobanana 配置，确认无 Mock 选项且可保存 3) 触发一次生成，未配置 endpoint 时应报 NANOBANANA_NOT_CONFIGURED，配置正确时应走远程生成 | evidence:npm run build:server OK; rg(NANOBANANA_MODE|nanobananaMode) 无命中; 文档已移除图片生成 mock 描述 | risk:low 主要为 UI 手动回归未跑"
"XHSIMG-030","P0","3","both","将 yunwuapi baseUrl/key 接入 Settings 与设置页","把 Gemini（现 nanobanana）远程调用所需 baseUrl/apiKey 接入 settings 表、IPC 与设置页表单，统一配置入口并避免泄露密钥。","settings:get 能返回用于 Gemini 远程调用的 baseUrl/key（可复用 nanobananaEndpoint/nanobananaApiKey 或新增别名）；settings:set/HTTP settings API 可持久化保存；UI 可编辑并回显（key 默认掩码显示）；保存后无需重启即可被后端读取。","AUTOSERVER,AUTOFRONTEND","密钥不得写入日志/前端明文展示；settings key 需白名单化与默认空值；兼容已有 nanobanana* 字段（如已有用户数据）；输入做基本校验（空/非法 URL）。","测试范围：settings 读写（IPC/HTTP）、UI 配置保存与回显；测试边界：baseUrl 为空/非法、apiKey 为空、包含特殊字符；测试方法：先用后端调用 settings 读写（或脚本/接口）验证持久化，再在 UI 设置页保存并刷新确认回显一致。","已完成","已完成","已完成","已提交","","plan/2026-01-14_13-43-32-gemini-jimeng-remote-only.md:18;src/pages/api/settings/index.ts:4;electron/main.js:79;src/server/settings.ts:40;src/components/settings/ApiConfigTab.tsx:187;src/components/settings/ApiConfigTab.tsx:355","picked_reason:先打通配置入口，供后续 Gemini/即梦远程实现复用; picked_at:2026-01-14 14:12:03 | done_at:2026-01-14 14:14:02 | validation_limited:未启动 UI 验证持久化与真实远程读取 | manual_test:1) npm run dev 2) 设置->Gemini 配置填写 Base URL(如 https://yunwu.ai) 与 API Key 3) 保存后刷新页面确认回显 4) 触发一次生成验证后端能读取该配置 | evidence:设置页文案已改为 Gemini/Base URL 且 placeholder 指向 yunwuapi; npm run build:server OK | risk:low 主要为 UI 手动回归未跑"
"XHSIMG-040","P0","4","backend","修正 Gemini（Nanobanana）远程调用实现","按参考项目契约修正 generateContent()：endpoint 拼接、鉴权 header、超时/重试、错误信息解析与响应字段映射，确保返回 imageBuffer 可用于落盘。","在正确配置 baseUrl/key 时，generateContent(prompt) 能成功返回非空 imageBuffer（可解码为图片文件）与 metadata；在 401/429/超时/响应字段缺失时抛出可定位错误（含 status 与截断 body），且不会输出/记录真实密钥。","AUTOSERVER","网络调用需设置合理超时与可控重试；错误日志需截断避免刷屏；响应字段缺失要有明确错误码前缀；不得保留 placeholder/mock 分支。","测试范围：正常生成、配置缺失、远程错误（401/429/5xx/超时）、响应解析；测试边界：prompt 空/全空白、超长（>2000）、响应缺 image_base64 或非 base64；测试方法：使用 Smoke 脚本分别跑成功与失败用例（通过改错 key/endpoint 触发），并检查错误信息是否可定位。","未开始","未开始","未开始","未提交","","plan/2026-01-14_13-43-32-gemini-jimeng-remote-only.md:19;src/server/services/xhs/integration/nanobananaClient.ts:87;src/server/services/xhs/integration/imageProvider.ts:336",""
"XHSIMG-050","P0","5","backend","修正即梦调用（直连/代理二选一）并统一输出","对齐参考项目：确认即梦走火山引擎直连（签名 + superbed）或 yunwuapi 代理；落地一致的超时/重试/429 冷却与输出结构。","选定方案后，model=jimeng 可稳定返回非空 imageBuffer；当触发并发限制/429 时进入冷却并可重试成功；配置缺失（AK/SK 或代理 key）时返回明确错误前缀；metadata 包含 model 与关键排障字段（如 prompt、imageUrls/requestId）。","AUTOSERVER","保持现有签名实现的正确性或提供等价代理实现；冷却/重试不得造成队列卡死；上传图片路径（superbed）失败要可定位；不要把 base64 通过 IPC 传输给 UI（优先落盘）。","测试范围：t2i（无 images）与 i2i（有 images）两类调用、重试与冷却、错误映射；测试边界：images 为空数组/非法 URL/base64、prompt 超长、返回 code!=10000；测试方法：用后端脚本分别跑 t2i/i2i，并通过制造 401/429/错误返回验证冷却与错误信息。","未开始","未开始","未开始","未提交","","plan/2026-01-14_13-43-32-gemini-jimeng-remote-only.md:20;src/server/services/xhs/integration/imageProvider.ts:187;src/server/services/xhs/integration/imageProvider.ts:323",""
"XHSIMG-060","P0","6","backend","新增 generateImage 脚本级 Smoke Test","新增可执行脚本直接调用 generateImage({prompt, model})，将输出写入 temp_images/ 并打印 metadata，作为远程调用的最小验证入口。","仓库内新增脚本可通过命令行运行，支持 --model/--prompt/--out 参数；成功时生成图片文件（>0 bytes）并输出 metadata；失败时以非 0 退出码返回并打印可读错误信息。","AUTOSERVER","脚本不得硬编码密钥；默认输出目录需在 .gitignore 范围内（如 temp_images/）；参数解析保持简单；错误栈输出需脱敏。","测试范围：脚本正常执行、参数解析、输出文件写入、错误退出码；测试边界：缺 prompt、model 非法值、out 指向不可写路径；测试方法：本地运行脚本 3 次（nanobanana/jimeng/非法参数），检查退出码与输出文件。","未开始","未开始","未开始","未提交","","plan/2026-01-14_13-43-32-gemini-jimeng-remote-only.md:21;src/server/services/xhs/integration/imageProvider.ts:323",""
"XHSIMG-070","P0","7","backend","脚本回归：成功生成 + 失败边界可定位","使用真实配置跑通两种模型，并覆盖关键失败场景（缺配置、401/429、超时、响应字段缺失），确保错误信息可定位且队列可继续处理。","Smoke 脚本可分别对 nanobanana/jimeng 生成至少 1 张可打开图片；对缺配置/401/429/超时/响应缺字段场景，输出包含明确错误前缀与 status（如有），且不会泄露密钥；失败后再次执行仍可成功（无永久冷却/锁死）。","AUTOSERVER","失败信息需可用于排障（包含关键上下文但需脱敏）；429 冷却与重试策略需可控（避免无限重试）；对响应体日志需截断。","测试范围：成功生成、失败映射、重试与冷却、重复执行稳定性；测试边界：prompt 空/超长、images 非法、endpoint 不可达、超时；测试方法：通过切换错误 key/endpoint/制造不可达地址触发失败，再恢复正确配置验证可再次成功。","未开始","未开始","未开始","未提交","","plan/2026-01-14_13-43-32-gemini-jimeng-remote-only.md:22;src/server/services/xhs/integration/nanobananaClient.ts:87;src/server/services/xhs/integration/imageProvider.ts:187",""
"XHSIMG-080","P1","8","both","UI 集成回归：队列生成落盘资产","通过 UI 创建生成任务/内容包，确认 generationQueue 能写入 assets、任务状态流转正常，且设置页配置生效（无 Mock 入口）。","在 UI 触发生成后，generation_tasks 状态能从 queued→generating→done；done 任务存在 result_asset_id 且 assets 文件可打开；失败任务为 failed 且 error_message 可读；设置页不再出现 Mock 选项且保存后立刻影响生成结果。","AUTOSERVER,AUTOE2E","避免在 UI/IPC 传输大体积 base64；生成流程失败需在 UI 侧可见并可追溯（taskId/error_message）；默认 model 策略需前后端一致。","测试范围：/api/generate 入队、队列处理、资产落盘、UI 展示与设置生效；测试边界：count=1/10、prompt 为空、model 缺省值不一致、远程失败；测试方法：先用后端脚本确认远程调用可用，再在 UI 依次触发单次与批量生成并检查状态与资产文件。","未开始","未开始","未开始","未提交","","plan/2026-01-14_13-43-32-gemini-jimeng-remote-only.md:23;src/pages/api/generate/index.ts:5;src/server/services/xhs/llm/generationQueue.ts:169;src/server/services/xhs/integration/imageProvider.ts:323;src/components/settings/ApiConfigTab.tsx:355",""
"XHSIMG-090","P2","9","both","更新文档与默认值：移除图片生成 Mock 描述","清理 docs 与默认值，移除/更新所有 Nanobanana mock 模式说明，并补充 yunwuapi 配置指引与排障信息。","docs 中不再出现“图片生成 mock/NANOBANANA_MODE=mock”的误导描述；新增或更新配置说明：需要填写 baseUrl/key、如何验证连通、常见错误（401/429/超时）；并确保没有把任何密钥写入仓库。","AUTOSERVER","文档变更需与实际实现一致；不要保留过期环境变量说明；所有示例 key 使用占位符；保证路径/命令可执行。","测试范围：文档一致性与可操作性；测试边界：示例中不得出现真实 key、不得出现旧 mock 开关；测试方法：rg 搜索 NANOBANANA_MODE/mock 相关关键字并人工抽查文档步骤可在本仓库执行。","未开始","未开始","未开始","未提交","","plan/2026-01-14_13-43-32-gemini-jimeng-remote-only.md:24;docs/Generation.md:15;docs/Config.md:9;docs/Settings.md:18",""
