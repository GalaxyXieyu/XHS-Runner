"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"IDEAUI-010","P0","1","both","定义 idea 一键生成契约与边界","落盘 idea→prompts→confirm→contentPackage 的最小契约与状态约定，明确不依赖 theme/topic 的默认行为。","输出一份契约说明（可在 plan 中补充或新增 docs），覆盖：preview/confirm/creatives/assets 的输入约束、输出结构、错误码前缀、状态流转；并给出 UI 状态映射（loading/可编辑/生成中/失败）。","AUTOSERVER","边界优先：不引入无关功能（主题/镜头）；字段命名与现有 API 保持兼容；错误码必须可定位且不泄露敏感信息。","测试范围：契约内容完整性与 refs 可跳转；测试边界：不得包含任何真实密钥、不得出现未枚举状态；测试方法：本地人工审阅 + rg 检查敏感串（sk- 等）+ 按 refs 跳转核对入口函数。","已完成","已完成","已完成","已提交","","docs/IdeaOneClickContract.md:1;src/pages/api/generate/preview.ts:1;src/pages/api/generate/confirm.ts:1;src/pages/api/creatives/index.ts:1;src/pages/api/assets/[id].ts:1","picked_reason:补齐契约与边界，减少前后端对齐成本; picked_at:2026-01-14 21:40:10 | done_at:2026-01-14 21:41:44 | evidence:next build OK; 契约文档已落盘并补齐错误前缀约定 | validation_limited:未对所有错误分支做运行时回归（仅文档+编译验证） | manual_test:1) 人工审阅 docs/IdeaOneClickContract.md 2) rg -n ""sk-"" docs/IdeaOneClickContract.md 确认无真实密钥 3) 按 refs 跳转核对 preview/confirm/creatives/assets 的输入输出 | risk:low 文档与接口字段保持向后兼容（error 仍为 string）"
"IDEAUI-020","P0","2","backend","补齐 preview/confirm 输入校验与错误码","为 preview/confirm 增加严格输入约束与可定位错误码前缀，并定义 styleKey/aspectRatio/count 的降级/拒绝策略。","preview：idea 为空返回 400；count 非法自动裁剪到 1-9；styleKey 不存在可降级为默认模板；LLM 返回非数组时返回 500 且错误包含 LLM_PARSE_ERROR。confirm：prompts 空/含空字符串返回 400；model 非法返回 400；服务端错误不输出密钥。","AUTOSERVER","校验逻辑必须覆盖边界值；错误信息需短且稳定（便于 UI 解析）；日志需截断且不得打印 key/URL query 中的 token。","测试范围：正常/边界/异常；测试边界：idea 空、count=0/10/字符串、styleKey 不存在、aspectRatio 非法、prompts 含空/超长、model 非法；测试方法：先用 curl/Postman 调 preview/confirm 覆盖用例，再运行 build:server 确认无类型错误。","已完成","已完成","已完成","已提交","","plan/2026-01-14_19-42-23-idea-preview-confirm-ui.md:21;src/pages/api/generate/preview.ts:9;src/pages/api/generate/confirm.ts:11;src/server/services/xhs/llm/ideaExpander.ts:25","picked_reason:先修后端校验与LLM报错可定位以解阻塞UI; picked_at:2026-01-14 11:51:49 | done_at:2026-01-14 11:55:45 | evidence:next build OK; preview/confirm 输入校验与降级逻辑已补齐 | validation_limited:未用 curl/Postman 覆盖全部边界用例 | manual_test:1) npm run dev:next 2) curl -X POST http://localhost:3000/api/generate/preview -H 'content-type: application/json' -d '{""idea"":""秋天的咖啡馆"",""styleKey"":""cozy"",""count"":4,""aspectRatio"":""3:4""}' 3) curl -X POST http://localhost:3000/api/generate/confirm -H 'content-type: application/json' -d '{""prompts"":[""p1""],""model"":""nanobanana""}' | risk:low 主要为未覆盖运行时HTTP回归"
"IDEAUI-030","P1","3","backend","补齐风格模板 API（列表/新增）","提供风格模板的可枚举 API（读取 8 种内置 + 用户模板），并提供新增用户模板的接口，与 confirm 的 saveAsTemplate 行为对齐。","新增 API：GET 返回模板列表（key/name/category/defaultAspectRatio）；POST 可创建用户模板（key/name/systemPrompt/promptSuffix 等最小字段）；UI 可拉取并显示 8 个内置模板；重复 key 不会覆盖内置。","AUTOSERVER","API 返回字段要稳定且可枚举；写入必须校验 key 格式（字母数字与 -_），避免 XSS/注入；不得返回 systemPrompt 全量给前端（除非明确需要）。","测试范围：模板列表/创建/冲突；测试边界：key 冲突、非法字符、name 空、systemPrompt 超长；测试方法：先跑脚本/接口验证（GET/POST），再在 UI 选择器中验证列表刷新与可用性。","已完成","已完成","已完成","已提交","","plan/2026-01-14_19-42-23-idea-preview-confirm-ui.md:25;src/pages/api/style-templates/index.ts:18;src/server/services/xhs/llm/styleTemplateService.ts:7;src/server/db/seeds/styleTemplates.ts:4","picked_reason:补齐风格模板列表/新增 API 以支撑 UI 枚举与自定义模板; picked_at:2026-01-14 20:55:20 | done_at:2026-01-14 21:37:37 | evidence:next build OK; 新增 /api/style-templates GET/POST | validation_limited:未调用 curl 覆盖冲突/非法 key 等边界 | manual_test:1) npm run dev:next 2) curl http://localhost:3000/api/style-templates 3) curl -X POST http://localhost:3000/api/style-templates -H 'content-type: application/json' -d '{""key"":""my-style-1"",""name"":""我的模板"",""systemPrompt"":""...""}' 4) 再次 GET 验证出现 | risk:low API 字段稳定且不返回 systemPrompt"
"IDEAUI-040","P0","4","frontend","CreativeTab 接入预览生成与 prompts 编辑","在 CreativeTab 增加 styleKey/count/aspectRatio/model 选择器与预览按钮，调用 preview API 并展示可编辑 prompts 列表（增删改/排序）。","点击预览后能展示 N 条 prompts；支持编辑单条文本、删除、调整顺序；LLM 未配置或解析失败时给出明确提示并允许手动编辑继续。","AUTOFRONTEND","避免与现有自动化小红书生成流程耦合；组件状态要可恢复（刷新/返回不崩）；输入内容需做最小长度限制与提示。","测试范围：预览/编辑/异常提示；测试边界：count=1/9、styleKey 不存在、idea 超长、prompts 为空/重复；测试方法：先用浏览器手测交互，再用 Chrome MCP 录制关键路径（输入→预览→编辑）并保存截图证据。","已完成","已完成","已完成","已提交","","plan/2026-01-14_19-42-23-idea-preview-confirm-ui.md:29;src/components/workspace/CreativeTab.tsx:263;src/pages/api/generate/preview.ts:4","picked_reason:UI 预览与 prompts 编辑是主路径入口; picked_at:2026-01-14 12:12:00 | done_at:2026-01-14 20:30:44 | evidence:next build OK; CreativeTab 已接入 /api/generate/preview 并支持 prompts 增删改/排序 | validation_limited:未执行浏览器手测与 Chrome MCP 录制（当前环境未跑 UI） | manual_test:1) npm run dev:next 2) 打开 CreativeTab → 选择『Idea 一键生成』 3) 输入 idea, 选择风格/比例/数量 4) 点击『生成预览』 5) 编辑 prompts（上移/下移/删除/新增） | risk:medium UI 交互未实测"
"IDEAUI-050","P0","5","frontend","确认弹窗与 confirm 调用入队","在 CreativeTab 增加确认弹窗，展示 prompts 数量与模型；确认后调用 confirm API，拿到 creativeId/taskIds 并进入生成中视图。","confirm 成功后 UI 保存 creativeId 并展示生成中状态；网络/服务端错误可提示并允许重试；不会重复提交导致重复任务（至少有按钮禁用/幂等保护）。","AUTOFRONTEND","提交前校验 prompts 非空且无全空白；避免重复点击导致多次入队；错误提示需可理解且不泄露后端细节。","测试范围：确认弹窗/提交/错误处理；测试边界：prompts 含空、model 切换、重复点击、后端 400/500；测试方法：浏览器手测 + Chrome MCP（预览→确认→进入生成中）截图留证。","已完成","已完成","已完成","已提交","","plan/2026-01-14_19-42-23-idea-preview-confirm-ui.md:34;src/components/workspace/CreativeTab.tsx:339;src/pages/api/generate/confirm.ts:7","picked_reason:预览已接入，继续接入 confirm 以串起生成闭环; picked_at:2026-01-14 20:38:02 | done_at:2026-01-14 20:38:30 | evidence:next build OK; confirm 弹窗+ /api/generate/confirm 入队已接入 | validation_limited:未执行浏览器手测与 Chrome MCP 录制（当前环境未跑 UI） | manual_test:1) npm run dev:next 2) CreativeTab → Idea 一键生成 → 生成预览 3) 点击『确认生成』 4) 弹窗确认入队 5) 验证显示 creativeId/taskIds 并按钮禁用 | risk:medium UI 交互与重复点击场景未实测"
"IDEAUI-060","P0","6","both","生成进度展示与内容包查看（按 creative 聚合）","实现生成中轮询与完成态展示：以 creatives/:id 返回的 tasks 状态为真相源，assets 逐步出现即可展示与预览。","当 tasks 状态变化时 UI 能更新；assets 生成后能通过 /api/assets/:id 正常预览；允许部分失败时给出可见提示；内容包可通过 creatives API 查询到完整结构（creative+tasks+assets）。","AUTOSERVER,AUTOFRONTEND","后端查询要避免 N+1 明显退化；前端轮询间隔与停止条件明确；失败信息需截断展示。","测试范围：生成中/完成/部分失败；测试边界：assets 为空、任务失败、creative 不存在 404；测试方法：先用接口 GET creatives/:id 观察 tasks/assets，再在 UI 验证实时刷新与图片展示（必要时用 Chrome MCP 截图）。","已完成","已完成","已完成","已提交","","plan/2026-01-14_19-42-23-idea-preview-confirm-ui.md:38;src/components/workspace/CreativeTab.tsx:228;src/server/services/xhs/content/creativeService.ts:39;src/pages/api/creatives/[id].ts:7;src/pages/api/assets/[id].ts:9","picked_reason:已可入队生成，下一步接入 creative 轮询与 assets 展示; picked_at:2026-01-14 20:42:10 | done_at:2026-01-14 20:50:50 | evidence:next build OK; idea creative 轮询+进度/图片展示已接入; listContentPackages 去除明显 N+1 | validation_limited:未执行真实入队生成后的 UI 轮询回归（当前环境未跑 dev/UI） | manual_test:1) npm run dev:next 2) 走预览→确认入队 3) 观察 UI 进度条/任务状态变化 4) 图片生成后能展示缩略图（/api/assets/:id） | risk:medium 依赖后端生成链路与数据一致性"
"IDEAUI-070","P0","7","both","测试路径落盘与自动回归脚本（含 Chrome MCP）","固化可执行的测试清单：脚本 smoke、API 用例、UI 端到端步骤；可选引入 Chrome MCP 做 UI 回归录制与截图留证。","仓库内有一份可执行测试说明（docs 或 scripts/readme），包含：styleTemplateSmoke 命令、preview/confirm curl 示例、UI 手工步骤与成功判定；Chrome MCP 流程可复现并有截图路径/日志。","AUTOE2E","测试步骤要具体到命令与期望输出；受限验收需写明原因与手工补测方法；避免把真实 key 写进文档。","测试范围：脚本/API/UI；测试边界：LLM 未配置（应提示）、接口 400/500、任务部分失败；测试方法：先跑脚本 smoke，再跑 curl 用例，最后 Chrome MCP 走 UI 全流程并保存截图证据。","已完成","已完成","已完成","已提交","","plan/2026-01-14_19-42-23-idea-preview-confirm-ui.md:42;docs/IdeaOneClickTesting.md:1;src/server/scripts/styleTemplateSmoke.ts:1;src/pages/api/generate/preview.ts:1;src/pages/api/generate/confirm.ts:1","picked_reason:把 smoke/API/UI 路径固化成可复现说明，方便回归; picked_at:2026-01-14 21:44:10 | done_at:2026-01-14 21:46:00 | evidence:测试路径文档已落盘（smoke/API/UI/Chrome MCP） | validation_limited:未实际运行脚本与 curl 覆盖全部边界（仅落盘步骤） | manual_test:按 docs/IdeaOneClickTesting.md 执行 smoke+curl+UI 并保存截图证据 | risk:low 仅新增文档"
"IDEAUI-080","P1","8","both","提示词质量评估与迭代（量化口径）","建立固定 idea 样本集与评估口径，迭代 ideaExpander 与各 styleTemplate 的提示词以提升小红书质感、一致性与差异化。","新增一个可重复的评估流程：固定 5-10 个 idea，生成 prompts 并记录输出；每轮迭代能对比一致性/差异性/风格符合度；输出一份迭代记录（样本 + 结论 + 下一步）。","AUTOSERVER","优化必须基于样本集对比，避免主观争论；解析逻辑要更鲁棒（非 JSON 数组要可定位错误）；不引入新依赖或复杂 agent 架构。","测试范围：样本集生成与对比；测试边界：LLM 返回杂质文本、数组元素非字符串、超长 prompt；测试方法：运行评估脚本生成日志/产物，再用 UI 随机抽样确认风格与差异性符合预期。","已完成","已完成","已完成","已提交","","plan/2026-01-14_19-42-23-idea-preview-confirm-ui.md:47;docs/IdeaPromptEval.md:1;src/server/scripts/ideaPromptEval.ts:1;src/server/services/xhs/llm/ideaExpander.ts:1;src/server/services/xhs/llm/styleTemplateService.ts:1","picked_reason:建立可重复的 prompts 质量评估口径与脚本，支持迭代; picked_at:2026-01-14 21:47:50 | done_at:2026-01-14 21:48:28 | evidence:next build OK; 评估脚本+评估口径文档已落盘 | validation_limited:未运行评估脚本（依赖 LLM 配置与外部服务） | manual_test:1) 配置好 LLM 后运行: npx tsx src/server/scripts/ideaPromptEval.ts > /tmp/idea-prompt-eval.jsonl 2) 对比不同 styleKey 输出的一致性/差异性 3) 记录结论与下一步到 docs/IdeaPromptEval.md | risk:low 仅新增脚本与文档"
